// Prisma schema for Kubidu PaaS Platform - REFACTORED

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for type safety
enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum ServiceType {
  GITHUB
  DOCKER_IMAGE
}

enum TemplateDeploymentStatus {
  PENDING
  DEPLOYING
  DEPLOYED
  FAILED
}

enum VolumeStatus {
  PENDING
  BOUND
  RELEASED
  FAILED
}

enum EnvironmentType {
  PRODUCTION
  STAGING
  DEVELOPMENT
  PREVIEW
}

enum NotificationCategory {
  DEPLOYMENT
  BUILD
  DOMAIN
  SERVICE
  WORKSPACE
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  DELETED
}

enum DeploymentStatus {
  PENDING
  BUILDING
  DEPLOYING
  RUNNING
  STOPPED
  FAILED
  CRASHED
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

// Workspace member roles
enum WorkspaceRole {
  ADMIN    // Full access: billing, members, settings, projects
  MEMBER   // Can create/manage projects and services
  DEPLOYER // Can only deploy, view logs, read-only on projects
}

// User accounts
model User {
  id               String     @id @default(uuid())
  email            String     @unique
  passwordHash     String     @map("password_hash")
  name             String?
  avatarUrl        String?    @map("avatar_url")
  emailVerified    Boolean    @default(false) @map("email_verified")
  twoFactorEnabled Boolean    @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?    @map("two_factor_secret")
  status           UserStatus @default(ACTIVE)
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  lastLoginAt      DateTime?  @map("last_login_at")
  deletedAt        DateTime?  @map("deleted_at")

  apiKeys                  ApiKey[]
  notifications            Notification[]
  notificationPreferences  NotificationPreference?
  gdprConsents             GdprConsent[]
  gdprRequests          GdprDataRequest[]
  auditLogs             AuditLog[]
  githubInstallations   GitHubInstallation[]
  workspaceMemberships  WorkspaceMember[]
  sentInvitations       WorkspaceInvitation[]

  @@index([email])
  @@map("users")
}

// Workspaces (multi-tenant organization layer)
model Workspace {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members       WorkspaceMember[]
  invitations   WorkspaceInvitation[]
  projects      Project[]
  subscription  Subscription?
  invoices      Invoice[]
  usageRecords  UsageRecord[]
  notifications Notification[]

  @@index([slug])
  @@map("workspaces")
}

// Workspace membership (many-to-many User <-> Workspace with role)
model WorkspaceMember {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  workspaceId String        @map("workspace_id")
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
  @@map("workspace_members")
}

// Workspace invitations (pending invites sent via email)
model WorkspaceInvitation {
  id          String        @id @default(uuid())
  workspaceId String        @map("workspace_id")
  email       String
  role        WorkspaceRole @default(MEMBER)
  token       String        @unique
  invitedById String        @map("invited_by_id")
  expiresAt   DateTime      @map("expires_at")
  acceptedAt  DateTime?     @map("accepted_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy User      @relation(fields: [invitedById], references: [id])

  @@unique([workspaceId, email])
  @@index([token])
  @@index([workspaceId])
  @@index([email])
  @@map("workspace_invitations")
}

// API keys for CLI authentication
model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  name        String
  keyHash     String    @unique @map("key_hash")
  keyPrefix   String    @map("key_prefix")
  permissions String[]
  expiresAt   DateTime? @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}

// Projects (container for services)
model Project {
  id          String        @id @default(uuid())
  workspaceId String        @map("workspace_id")
  name        String
  slug        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  deletedAt   DateTime?     @map("deleted_at")

  workspace           Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  services            Service[]
  templateDeployments TemplateDeployment[]
  volumes             Volume[]
  environments        Environment[]
  webhooks            Webhook[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("projects")
}

// Environments (Production, Staging, Development, PR-Previews)
model Environment {
  id            String          @id @default(uuid())
  projectId     String          @map("project_id")
  name          String
  slug          String
  type          EnvironmentType @default(DEVELOPMENT)
  isProduction  Boolean         @default(false) @map("is_production")
  isDefault     Boolean         @default(false) @map("is_default")
  color         String?         // UI color for identification (e.g., "#16A34A")
  
  // Auto-deploy settings
  autoDeploy    Boolean         @default(true) @map("auto_deploy")
  branch        String?         // Git branch to deploy from (e.g., "main", "staging")
  
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  
  project       Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  variables     EnvironmentVar[]
  deployments   EnvironmentDeployment[]
  
  @@unique([projectId, slug])
  @@index([projectId])
  @@index([projectId, type])
  @@map("environments_v2")
}

// Environment-specific variables (overrides service defaults)
model EnvironmentVar {
  id             String      @id @default(uuid())
  environmentId  String      @map("environment_id")
  key            String
  valueEncrypted String      @map("value_encrypted")
  valueIv        String      @map("value_iv")
  isSecret       Boolean     @default(true) @map("is_secret")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  
  environment    Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  
  @@unique([environmentId, key])
  @@index([environmentId])
  @@map("environment_vars")
}

// Environment-specific deployment tracking
model EnvironmentDeployment {
  id            String      @id @default(uuid())
  environmentId String      @map("environment_id")
  deploymentId  String      @map("deployment_id")
  serviceId     String      @map("service_id")
  isActive      Boolean     @default(false) @map("is_active")
  deployedAt    DateTime    @default(now()) @map("deployed_at")
  
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  
  @@index([environmentId])
  @@index([serviceId])
  @@map("environment_deployments")
}

// Services (GitHub repos or Docker images)
model Service {
  id          String        @id @default(uuid())
  projectId   String        @map("project_id")
  name        String
  serviceType ServiceType   @map("service_type")
  status      ServiceStatus @default(ACTIVE)

  // GitHub source fields
  repositoryUrl        String? @map("repository_url")
  repositoryProvider   String? @map("repository_provider")
  repositoryBranch     String? @default("main") @map("repository_branch")
  githubInstallationId String? @map("github_installation_id")
  githubRepoFullName   String? @map("github_repo_full_name")

  // Docker image source fields
  dockerImage String? @map("docker_image")
  dockerTag   String? @default("latest") @map("docker_tag")

  // Default deployment configuration (can be overridden per deployment)
  defaultPort            Int     @default(8080) @map("default_port")
  defaultReplicas        Int     @default(1) @map("default_replicas")
  defaultCpuLimit        String  @default("1000m") @map("default_cpu_limit")
  defaultMemoryLimit     String  @default("512Mi") @map("default_memory_limit")
  defaultCpuRequest      String  @default("100m") @map("default_cpu_request")
  defaultMemoryRequest   String  @default("128Mi") @map("default_memory_request")
  defaultHealthCheckPath String  @default("/") @map("default_health_check_path")
  defaultStartCommand    String? @map("default_start_command")

  // Public subdomain (e.g., "myapp" becomes "myapp.172.21.0.4.nip.io")
  subdomain String? @unique @map("subdomain")

  // Public URL - points to the active deployment
  url String? @map("url")

  autoDeploy Boolean  @default(true) @map("auto_deploy")

  // Autoscaling configuration
  autoscalingEnabled          Boolean @default(false) @map("autoscaling_enabled")
  autoscalingMinReplicas      Int     @default(1) @map("autoscaling_min_replicas")
  autoscalingMaxReplicas      Int     @default(10) @map("autoscaling_max_replicas")
  autoscalingTargetCPU        Int     @default(70) @map("autoscaling_target_cpu")
  autoscalingTargetMemory     Int?    @map("autoscaling_target_memory")

  // Canvas position for visual layout
  canvasX Float? @default(0) @map("canvas_x")
  canvasY Float? @default(0) @map("canvas_y")

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Link to template deployment (null for manually created services)
  templateDeploymentId String?             @map("template_deployment_id")
  templateDeployment   TemplateDeployment? @relation(fields: [templateDeploymentId], references: [id], onDelete: SetNull)

  project              Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  githubInstallation   GitHubInstallation?   @relation(fields: [githubInstallationId], references: [id], onDelete: SetNull)
  deployments          Deployment[]
  environmentVariables EnvironmentVariable[]
  domains              Domain[]
  buildQueue           BuildQueue[]
  webhookEvents        WebhookEvent[]
  consumingReferences  EnvVarReference[]     @relation("consumingReferences")
  providingReferences  EnvVarReference[]     @relation("providingReferences")
  volumes              Volume[]

  @@index([projectId])
  @@index([projectId, status])
  @@index([githubInstallationId])
  @@index([templateDeploymentId])
  @@map("services")
}

// GitHub App installations
model GitHubInstallation {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  installationId   Int       @unique @map("installation_id")
  accountLogin     String    @map("account_login")
  accountType      String    @map("account_type")
  accountAvatarUrl String?   @map("account_avatar_url")
  permissions      Json?
  suspendedAt      DateTime? @map("suspended_at")
  uninstalledAt    DateTime? @map("uninstalled_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  services Service[]

  @@index([userId])
  @@map("github_installations")
}

// Deployments (instances of services)
model Deployment {
  id               String           @id @default(uuid())
  serviceId        String           @map("service_id")
  name             String
  status           DeploymentStatus @default(PENDING)

  // Build information
  imageUrl         String? @map("image_url")
  imageTag         String? @map("image_tag")
  buildLogs        String? @map("build_logs")
  gitCommitSha     String? @map("git_commit_sha")
  gitCommitMessage String? @map("git_commit_message")
  gitAuthor        String? @map("git_author")

  // Runtime configuration (can override service defaults)
  port            Int?    @map("port")
  replicas        Int?    @map("replicas")
  cpuLimit        String? @map("cpu_limit")
  memoryLimit     String? @map("memory_limit")
  cpuRequest      String? @map("cpu_request")
  memoryRequest   String? @map("memory_request")
  healthCheckPath String? @map("health_check_path")

  // Runtime logs and metrics
  deploymentLogs String? @map("deployment_logs")

  // Active deployment tracking (only one active per service)
  isActive Boolean @default(false) @map("is_active")

  // Lifecycle timestamps
  deployedAt DateTime? @map("deployed_at")
  stoppedAt  DateTime? @map("stopped_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  service              Service               @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  environmentVariables EnvironmentVariable[]

  @@index([serviceId])
  @@index([serviceId, status])
  @@index([status])
  @@map("deployments")
}

// Environment variables (encrypted)
// Service-level: inherited by all deployments of that service
// Deployment-level: overrides service-level for specific deployment
model EnvironmentVariable {
  id             String    @id @default(uuid())
  serviceId      String?   @map("service_id")
  deploymentId   String?   @map("deployment_id")
  key            String
  valueEncrypted String    @map("value_encrypted")
  valueIv        String    @map("value_iv")
  isSecret       Boolean   @default(true) @map("is_secret")
  isSystem       Boolean   @default(false) @map("is_system")
  isShared       Boolean   @default(false) @map("is_shared")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  service    Service?    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  deployment Deployment? @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@unique([serviceId, deploymentId, key], name: "env_var_scope_key_unique")
  @@index([serviceId])
  @@index([deploymentId])
  @@map("environment_variables")
}

// Custom domains (tied to services, not deployments)
model Domain {
  id               String    @id @default(uuid())
  serviceId        String    @map("service_id")
  domain           String    @unique
  verificationCode String?   @map("verification_code")
  isVerified       Boolean   @default(false) @map("is_verified")
  verifiedAt       DateTime? @map("verified_at")
  sslCertificate   String?   @map("ssl_certificate")
  sslKey           String?   @map("ssl_key")
  sslExpiresAt     DateTime? @map("ssl_expires_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([domain])
  @@map("domains")
}

// Build queue
model BuildQueue {
  id                   String    @id @default(uuid())
  serviceId            String    @map("service_id")
  deploymentId         String    @map("deployment_id")
  status               String    @default("pending")
  buildStartTime       DateTime? @map("build_start_time")
  buildEndTime         DateTime? @map("build_end_time")
  buildDurationSeconds Int?      @map("build_duration_seconds")
  errorMessage         String?   @map("error_message")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([deploymentId])
  @@index([status])
  @@map("build_queue")
}

// Webhook events
model WebhookEvent {
  id          String    @id @default(uuid())
  serviceId   String    @map("service_id")
  provider    String
  eventType   String    @map("event_type")
  payload     Json
  signature   String?
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at")
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([processed])
  @@map("webhook_events")
}

// Subscriptions (Stripe) - tied to Workspace for billing
model Subscription {
  id                   String             @id @default(uuid())
  workspaceId          String             @unique @map("workspace_id")
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  plan                 SubscriptionPlan
  status               SubscriptionStatus
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  canceledAt           DateTime?          @map("canceled_at")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

// Usage tracking - tied to Workspace for billing
model UsageRecord {
  id            String   @id @default(uuid())
  workspaceId   String   @map("workspace_id")
  resourceType  String   @map("resource_type")
  amount        Float
  unit          String
  recordedAt    DateTime @map("recorded_at")
  billingPeriod String   @map("billing_period")
  projectId     String?  @map("project_id")
  deploymentId  String?  @map("deployment_id")
  createdAt     DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, billingPeriod])
  @@index([recordedAt])
  @@index([projectId, billingPeriod])
  @@index([deploymentId, recordedAt])
  @@map("usage_records")
}

// Invoices - tied to Workspace for billing
model Invoice {
  id              String    @id @default(uuid())
  workspaceId     String    @map("workspace_id")
  stripeInvoiceId String?   @map("stripe_invoice_id")
  amount          Float
  currency        String    @default("usd")
  status          String
  dueDate         DateTime? @map("due_date")
  paidAt          DateTime? @map("paid_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([stripeInvoiceId])
  @@map("invoices")
}

// Audit logs (ISO 27001 compliance)
model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  metadata   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@index([resource, resourceId])
  @@map("audit_logs")
}

// GDPR consents
model GdprConsent {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  consentType    String   @map("consent_type")
  consentVersion String   @map("consent_version")
  consentGiven   Boolean  @map("consent_given")
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  createdAt      DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("gdpr_consents")
}

// GDPR data requests
model GdprDataRequest {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  requestType String    @map("request_type")
  status      String
  downloadUrl String?   @map("download_url")
  expiresAt   DateTime? @map("expires_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("gdpr_data_requests")
}

// Environment variable references (cross-service sharing)
model EnvVarReference {
  id              String   @id @default(uuid())
  serviceId       String   @map("service_id")
  sourceServiceId String   @map("source_service_id")
  key             String
  alias           String?
  createdAt       DateTime @default(now()) @map("created_at")

  service       Service @relation("consumingReferences", fields: [serviceId], references: [id], onDelete: Cascade)
  sourceService Service @relation("providingReferences", fields: [sourceServiceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, sourceServiceId, key])
  @@index([serviceId])
  @@index([sourceServiceId])
  @@map("env_var_references")
}

// Notifications
model Notification {
  id          String               @id @default(uuid())
  userId      String               @map("user_id")
  workspaceId String               @map("workspace_id")
  category    NotificationCategory
  title       String
  message     String
  actionUrl   String?              @map("action_url")
  metadata    Json?
  isRead      Boolean              @default(false) @map("is_read")
  emailSent   Boolean              @default(false) @map("email_sent")
  createdAt   DateTime             @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([workspaceId])
  @@map("notifications")
}

// Notification preferences
model NotificationPreference {
  id                  String  @id @default(uuid())
  userId              String  @unique @map("user_id")
  emailDeploySuccess  Boolean @default(true) @map("email_deploy_success")
  emailDeployFailed   Boolean @default(true) @map("email_deploy_failed")
  emailBuildFailed    Boolean @default(true) @map("email_build_failed")
  emailDomainVerified Boolean @default(true) @map("email_domain_verified")
  emailInvitations    Boolean @default(true) @map("email_invitations")
  emailRoleChanges    Boolean @default(true) @map("email_role_changes")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// Templates (pre-defined multi-service application stacks)
model Template {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?  // URL or emoji
  category    String?  // "database", "cms", "backend", etc.

  // Template definition (JSON) - services, env vars, volumes
  definition  Json

  // Metadata
  isOfficial  Boolean  @default(false) @map("is_official")
  isPublic    Boolean  @default(true) @map("is_public")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  deployments TemplateDeployment[]

  @@index([category])
  @@index([isPublic])
  @@map("templates")
}

// Template deployments (instances of templates in projects)
model TemplateDeployment {
  id            String                   @id @default(uuid())
  templateId    String                   @map("template_id")
  projectId     String                   @map("project_id")

  status        TemplateDeploymentStatus @default(PENDING)
  statusMessage String?                  @map("status_message")

  createdAt     DateTime                 @default(now()) @map("created_at")
  updatedAt     DateTime                 @updatedAt @map("updated_at")

  template      Template                 @relation(fields: [templateId], references: [id])
  project       Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  services      Service[]
  volumes       Volume[]

  @@index([templateId])
  @@index([projectId])
  @@index([status])
  @@map("template_deployments")
}

// Volumes (persistent storage for services)
model Volume {
  id                   String              @id @default(uuid())
  projectId            String              @map("project_id")
  serviceId            String?             @map("service_id")
  templateDeploymentId String?             @map("template_deployment_id")

  name                 String
  mountPath            String              @map("mount_path")
  size                 String              // e.g., "10Gi"

  status               VolumeStatus        @default(PENDING)
  boundAt              DateTime?           @map("bound_at")

  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  project              Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  service              Service?            @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  templateDeployment   TemplateDeployment? @relation(fields: [templateDeploymentId], references: [id], onDelete: SetNull)

  @@unique([projectId, name])
  @@index([projectId])
  @@index([serviceId])
  @@index([templateDeploymentId])
  @@map("volumes")
}

// Webhook types
enum WebhookType {
  DISCORD
  SLACK
  CUSTOM
}

// Outgoing Webhooks (for notifications)
model Webhook {
  id          String      @id @default(uuid())
  projectId   String      @map("project_id")
  
  name        String
  url         String
  type        WebhookType @default(CUSTOM)
  secret      String?     // HMAC secret for signing
  
  // Event subscriptions
  events      String[]    // e.g., ["deployment.success", "deployment.failed", "build.started"]
  
  enabled     Boolean     @default(true)
  
  // Delivery stats
  lastDeliveryAt   DateTime? @map("last_delivery_at")
  lastDeliveryOk   Boolean?  @map("last_delivery_ok")
  failureCount     Int       @default(0) @map("failure_count")
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]
  
  @@index([projectId])
  @@index([enabled])
  @@map("webhooks")
}

// Webhook delivery log
model WebhookDelivery {
  id          String   @id @default(uuid())
  webhookId   String   @map("webhook_id")
  
  event       String   // e.g., "deployment.success"
  payload     Json
  
  statusCode  Int?     @map("status_code")
  response    String?  // First 1KB of response
  error       String?
  
  duration    Int?     // Response time in ms
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_deliveries")
}
